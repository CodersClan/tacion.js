/* Tacion v0.1.2 | GPLv2 + MIT | http://azof.fr/tacionjs */ (function(a,b,c,d,e,f){function j(a){var c=f.Deferred();g.document=f(c.resolve).on("pagebeforechange",I),c.then(function(){F("loading presentation"),g.body=f(b.body),g.html=g.body.closest("html").andSelf()});var d=A("manifest.json",a);f.when(d,c).then(function(a){k(a.shift())})}function k(a){h.slides=a.slides,h.slideCount=a.slides.length,l(a),a.template?A(a.template).then(C).then(D):(C('<div data-role="page">{{content}}</div>'),D())}function l(a){n(!1,!1),a.pusher?(i.api=new d(a.pusher,{encrypted:!0}),u(),w("connection","state_change",m),a.server&&f.getJSON(a.server).then(function(b){b&&b.api_key===a.pusher&&(i.server=a.server,v())})):u()}function m(a){var b={failed:"Syncing support unavailable for this device.",disconnected:"Connection lost! Will try again momentarily..."};a.current in b?(n(!1,!1),Z(b[event.current])):a.current==="connected"&&(n(!0,!0),Z(!1))}function n(a,b){i.enabled!==a&&(i.enabled=a,t(a),i.role==="passenger"&&o(!a)),i.switchable!==b&&b!==undefined&&(i.switchable=b),i.switches.slider(i.switchable?"enable":"disable");var c=a?"syncing":"off";i.switches.val(c).slider("refresh")}function o(a){var b=!!a;if(i.manual!==b){var c=(i.manual=b)?"on":"off",d="swipeleft swiperight keyup";g.document[c](d,p)}}function p(a){var b=".ui-focus,.ui-focus *";if(!f(a.target).is(b))if(a.type==="swipeleft")q();else if(a.type==="swiperight")r();else switch(a.which){case 37:r();break;case 39:case 32:q()}}function q(){var a=h.slide,b=h.step,c=a+1,d=b+1;K(a).then(function(b){var e=b.data("steps").not(".active");e.size()>0?G(d,a):c<h.slideCount&&G(0,c)})}function r(){var a=h.slide,b=h.step,c=a-1,d=b-1;d>=0?G(d,a):c>=0&&G(0,c)}function s(a,b){var c=a.data("alternators"),d="ui-bar-"+c.data("sync-theme");c.toggleClass(d,b)}function t(a){f.each(h.slides,function(b,c){c.then&&c.then(function(b){s(b,a)})})}function u(){g.body.addClass(i.role="passenger"),g.body.removeClass("driver"),w("sync","state",U),o(!!i.manual)}function v(){g.body.addClass(i.role="driver"),g.body.removeClass("passenger"),x("sync","state",U),o(!0)}function w(a,b,c){if(a&&i.api){var d=z(a);b&&c&&d.bind(b,c)}}function x(a,b,c){if(a in i.channels&&i.api){var d=z(a);b&&c&&d.unbind(b,c)}}function y(a,b,c){return f.ajax({url:i.server,type:"POST",contentType:"application/json",data:JSON.stringify({channel:a,event:b,data:c})})}function z(a){return a==="connection"?i.api.connection:a in i.channels?i.channels[a]:i.channels[a]=i.api.subscribe(a)}function A(a,b){return f.get(B(a,b))}function B(a,b){return b&&(h.rootFolder=b),h.rootFolder+"/"+a}function C(a){h.template=a}function D(){var a=E(location);G(a.step,a.slide,{transition:"fade"})}function E(b){var c=b?e.path.parseUrl(b):a.location,d=c.hash.split("#").pop(),g=d.split("&"),h={slide:0,step:0};return f.each(g,function(a,b){b=b.split("="),h[b[0]]=parseInt(b[1],10)}),h}function F(a){a?e.showPageLoadingMsg("a",a,!0):e.hidePageLoadingMsg()}function G(a,b,c){a=H(a)?a:0,b=H(b)?b:0,e.changePage("#slide="+b+"&step="+a,c)}function H(a){return f.type(a)==="number"&&a>=0}function I(a,b){var c=b.toPage;if(f.type(c)==="string"){var d=E(c);J(d.slide,d.step,b),a.preventDefault()}}function J(a,b,c){F("loading slide"),i.role==="driver"&&U({slide:a,step:b});var d={dataUrl:c.toPage,allowSamePageTransition:!0,reverse:a<h.slide},g=h.slide!==a,j={transition:g?"slide":"none"};h.slide=a,h.step=b,K(a).then(function(a){a.data("transition")&&(j.transition=a.data("transition")),g&&T(0,0);var i=c.options||{},k=f.extend(j,i,d);e.changePage(a,k),R(b,a),V("update",{page:a,slide:h.slide,step:h.step})}).fail(function(a){Z("Unable to find slide #"+a)})}function K(a){var b=h.slides[a];return b===undefined?f.Deferred().reject(a):(b.then||(b=h.slides[a]=L(b)),b.promise())}function L(a){var b=f.Deferred();return A(a).then(function(a){M(a).then(b.resolve)}),b.promise()}function M(a){var b=f.Deferred(),d=Q(a),e=d.find("[data-role=content]"),j=d.find(".alert"),k=d.find("link[href]").remove(),l=d.find("[data-step]"),m=d.find("[data-sync-theme]"),n=e.attr("id")||h.slide,o=e.data("page-step");o&&l.push(d.attr("data-step",o).get(0)),d.attr("id",n+"-page").data({steps:l,alternators:m,alert:j}).appendTo(g.body).page();var p=d.find(".sync");p.size()&&p.each(O).change(P),s(d,i.enabled),j.size()&&j.on("click",function(){j.removeClass("active")});var q=f.makeArray(k.map(N)),r=function(){b.resolve(d)};return q.length?c({load:q,complete:r}):r(),b.promise()}function N(a,b){var c=f(b).attr("href");return c in h.assets?undefined:(h.assets[c]=!0,B(c))}function O(a,b){i.switches.push(b),n(i.enabled)}function P(a){var b=f(a.target).val();n(b==="syncing"),g.body.focus()}function Q(a){var b=/\{\{([a-z]+)\}\}/g,c=h.template,d=c.replace(b,function(b,c){if(c==="content")return a;if(c==="index")return h.slide+1;if(c==="count")return h.slideCount});return f(d)}function R(a,b){var c,d=100;b.data("steps").each(function(){var b=f(this),d=b.data("step")<=a;d?(!b.hasClass("active")&&!c&&(c=b),b.addClass("active")):b.removeClass("active")}),c&&!S(c,d)&&T(c.offset().top-d)}function S(b,c){var d=b.get(0),e=d.offsetTop,f=d.offsetLeft,g=d.offsetWidth,h=d.offsetHeight;while(d.offsetParent)d=d.offsetParent,e+=d.offsetTop,f+=d.offsetLeft;return e>=a.pageYOffset&&f>=a.pageXOffset&&e+h<=a.pageYOffset+a.innerHeight-(c||0)&&f+g<=a.pageXOffset+a.innerWidth}function T(a,b){var c=Math.max(a,0),d=b!==undefined?b:500,e=function(){g.window.trigger("resize")};g.html.animate({scrollTop:c},{duration:d,step:e})}function U(a){i.enabled&&(i.role==="passenger"?G(a.step,a.slide):y("sync","state",a))}function V(a,b){g.window.trigger(Y(a),b)}function W(a,b){g.window.on(Y(a),b)}function X(a,b){g.window.off(Y(a),b)}function Y(a){return"tacion:"+a}function Z(b){F(!1);var c=function(){f.type(b)==="string"&&a.alert(b)};K(h.slide).then(function(a){var d=a.data("alert");d?f.type(b)==="string"?(d.children(".message").text(b),d.addClass("active"),T(0)):d.removeClass("active"):c()}).fail(c)}"use strict";var g={window:f(a)},h={assets:{},slide:0,step:0},i={role:"passenger",switches:f(),channels:{}};a.tacion={alert:Z,change:G,next:q,off:X,on:W,prev:r,spinner:F,start:j}})(window,document,yepnope,Pusher,jQuery.mobile,jQuery),function(a,b){"use strict";var c=a.getActive,d=$(b);a.getActive=function(){var a=c()||{};return a.lastScroll===undefined&&(a.lastScroll=d.scrollTop()),a}}(jQuery.mobile.urlHistory,window);
