/* Tacion v0.1.3 | GPLv2 + MIT | http://azof.fr/tacionjs */ (function(a,b,c,d,e,f){function j(a){var c=f.Deferred();g.document=f(c.resolve),c.then(function(){F("loading presentation"),g.body=f(b.body),g.html=g.body.closest("html").andSelf()});var d=A("manifest.json",a);f.when(d,c).then(function(a){k(a.shift())})}function k(a){h.slides=a.slides,h.slideCount=a.slides.length,l(a),a.template?A(a.template).then(C).then(D):(C('<div data-role="page">{{content}}</div>'),D())}function l(a){n(!1,!1);if(a.api_key){var b=function(){i.socket=new d(a.api_key,{encrypted:!0}),w("connection","state_change",m),u()},c=function(){i.server=a.server,n(!0,!0),v()};a.server?f.getJSON(a.server).then(function(d){d&&d.api_key===a.api_key?c():b()}).fail(b):b()}else u()}function m(a){var b={failed:"Syncing support unavailable for this device.",disconnected:"Connection lost! Will try again momentarily..."};a.current in b?(n(!1,!1),$(b[event.current])):a.current==="connected"&&(n(!0,!0),$(!1))}function n(a,b){i.enabled!==a&&(i.enabled=a,t(a),i.role==="passenger"&&o(!a)),i.switchable!==b&&b!==undefined&&(i.switchable=b),i.switches.slider(i.switchable?"enable":"disable");var c=a?"syncing":"off";i.switches.val(c).slider("refresh")}function o(a){var b=!!a;if(i.manual!==b){var c=(i.manual=b)?"on":"off",d="swipeleft swiperight keyup";g.document[c](d,p)}}function p(a){var b=".ui-focus,.ui-focus *";if(!f(a.target).is(b))if(a.type==="swipeleft")q();else if(a.type==="swiperight")r();else switch(a.which){case 37:r();break;case 39:case 32:q()}}function q(){var a=h.slide,b=h.step,c=a+1,d=b+1;L(a).then(function(b){var e=b.data("steps").not(".active");e.size()>0?G(d,a):c<h.slideCount&&G(0,c)})}function r(){var a=h.slide,b=h.step,c=a-1,d=b-1;d>=0?G(d,a):c>=0&&G(0,c)}function s(a,b){var c=a.data("alternators"),d="ui-bar-"+c.data("sync-theme");c.toggleClass(d,b)}function t(a){f.each(h.slides,function(b,c){c.then&&c.then(function(b){s(b,a)})})}function u(){g.body.addClass(i.role="passenger"),g.body.removeClass("driver"),w("sync","state",V),o(!!i.manual)}function v(){g.body.addClass(i.role="driver"),g.body.removeClass("passenger"),o(!0)}function w(a,b,c){if(a&&i.socket){var d=z(a);b&&c&&d.bind(b,c)}}function x(a,b,c){if(a in i.channels&&i.socket){var d=z(a);b&&c&&d.unbind(b,c)}}function y(a,b,c){return f.ajax({url:i.server,type:"POST",contentType:"application/json",data:JSON.stringify({channel:a,event:b,data:c})})}function z(a){return a==="connection"?i.socket.connection:a in i.channels?i.channels[a]:i.channels[a]=i.socket.subscribe(a)}function A(a,b){return f.get(B(a,b))}function B(a,b){return b&&(h.rootFolder=b),h.rootFolder+"/"+a}function C(a){h.template=a}function D(){var a=E(location);g.document.on("pagebeforechange",I),G(a.step,a.slide)}function E(b){var c=b?e.path.parseUrl(b):a.location,d=c.hash.split("#").pop(),g=d.split("&"),h={slide:0,step:0};return f.each(g,function(a,b){b=b.split("="),h[b[0]]=parseInt(b[1],10)}),h}function F(a){a?e.showPageLoadingMsg("a",a,!0):e.hidePageLoadingMsg()}function G(a,b,c){a=H(a)?a:0,b=H(b)?b:0,e.changePage("#slide="+b+"&step="+a,c)}function H(a){return f.type(a)==="number"&&a>=0}function I(a,b){var c=b.toPage;if(f.type(c)==="string"){var d=E(c);K(d.slide,d.step,b),a.preventDefault()}}function J(a,b,c){var d={dataUrl:c.toPage,allowSamePageTransition:!0,reverse:a<h.slide,isNewSlide:h.slide!==a},e={transition:d.isNewSlide?"fade":"none"};return f.extend(e,c.options||{},d)}function K(a,b,c){F("loading slide");var d=J(a,b,c);L(a).then(function(c){d.isNewSlide&&U(0,0),e.changePage(c,d),S(b,c),W("update",{page:c,slide:h.slide=a,step:h.step=b})}),i.role==="driver"&&V({slide:a,step:b})}function L(a){var b=h.slides?h.slides[a]:undefined;return b===undefined?f.Deferred().reject(a):(b.then||(b=h.slides[a]=M(a,b)),b.promise())}function M(a,b){var c=f.Deferred();return A(b).then(function(b){N(a,b).then(c.resolve)}),c.promise()}function N(a,b){var d=f.Deferred(),a=R(a,b),e=a.find("[data-role=content]"),h=a.find(".alert"),j=a.find("link[href]").remove(),k=a.find("[data-step]"),l=a.find("[data-sync-theme]"),m=e.attr("id"),n=e.data("page-step");n&&k.push(a.attr("data-step",n).get(0)),a.attr("id",m+"-page").data({steps:k,alternators:l,alert:h}).appendTo(g.body).page();var o=a.find(".sync");o.size()&&o.each(P).change(Q),s(a,i.enabled),h.size()&&h.on("click",function(){h.removeClass("active")});var p=f.makeArray(j.map(O)),q=function(){d.resolve(a)};return p.length?c({load:p,complete:q}):q(),d.promise()}function O(a,b){var c=f(b).attr("href");return c in h.assets?undefined:(h.assets[c]=!0,B(c))}function P(a,b){i.switches.push(b),n(i.enabled)}function Q(a){var b=f(a.target).val();n(b==="syncing"),g.body.focus()}function R(a,b){var c=/\{\{([a-z]+)\}\}/g,d=h.template,e=d.replace(c,function(c,d){if(d==="content")return b;if(d==="index")return a+1;if(d==="count")return h.slideCount});return f(e)}function S(a,b){var c,d=100;b.data("steps").each(function(){var b=f(this),d=b.data("step")<=a;d?(!b.hasClass("active")&&!c&&(c=b),b.addClass("active")):b.removeClass("active")}),c&&!T(c,d)&&U(c.offset().top-d)}function T(b,c){var d=b.get(0),e=d.offsetTop,f=d.offsetLeft,g=d.offsetWidth,h=d.offsetHeight;while(d.offsetParent)d=d.offsetParent,e+=d.offsetTop,f+=d.offsetLeft;return e>=a.pageYOffset&&f>=a.pageXOffset&&e+h<=a.pageYOffset+a.innerHeight-(c||0)&&f+g<=a.pageXOffset+a.innerWidth}function U(a,b){var c=Math.max(a,0),d=b!==undefined?b:500,e=function(){g.window.trigger("resize")};g.html.animate({scrollTop:c},{duration:d,step:e})}function V(a){i.enabled&&(i.role==="passenger"?G(a.step,a.slide):y("sync","state",a))}function W(a,b){g.window.trigger(Z(a),b)}function X(a,b){g.window.on(Z(a),b)}function Y(a,b){g.window.off(Z(a),b)}function Z(a){return"tacion:"+a}function $(b){F(!1);var c=function(){f.type(b)==="string"&&a.alert(b)};L(h.slide).then(function(a){var d=a.data("alert");d?f.type(b)==="string"?(d.children(".message").text(b),d.addClass("active"),U(0)):d.removeClass("active"):c()}).fail(c)}"use strict";var g={window:f(a)},h={assets:{},slide:0,step:0},i={role:"passenger",switches:f(),channels:{}};a.tacion={alert:$,change:G,next:q,off:Y,on:X,prev:r,spinner:F,start:j}})(window,document,yepnope,Pusher,jQuery.mobile,jQuery),function(a,b){"use strict";var c=a.getActive,d=$(b);a.getActive=function(){var a=c()||{};return a.lastScroll===undefined&&(a.lastScroll=d.scrollTop()),a}}(jQuery.mobile.urlHistory,window);
