/**
 * Tacion v0.1.0
 *  A jQuery Mobile framework for creating real-time presentations
 *  http://azoff.github.com/tacion.js
 *
 * Copyright 2012, Jonathan Azoff
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *  http://jquery.org/license
 *
 * For usage and documentation, see the README file
 *  http://azof.fr/tacionjs
 *
 * Date: Saturday, June 17th 2012
 *//*global yepnope, Pusher */(function(a,b,c,d,e,f){function j(a){var c=f.Deferred();g.document=f(c.resolve).on("pagebeforechange",H),c.then(function(){E("loading presentation"),g.body=f(b.body),g.html=g.body.closest("html").andSelf()});var d=z("manifest.json",a);f.when(d,c).then(function(a){k(a.shift())})}function k(a){h.slides=a.slides,h.slideCount=a.slides.length,l(a),a.template?z(a.template).then(B).then(C):(B('<div data-role="page">{{content}}</div>'),C())}function l(a){n(!1,!1),a.pusher?(i.api=new d(a.pusher,{encrypted:!0}),t(),v("connection","state_change",m),a.server&&f.getJSON(a.server).then(function(b){b&&b.api_key===a.pusher&&(i.server=a.server,u())})):t()}function m(a){var b={failed:"Syncing support unavailable for this device.",disconnected:"Connection lost! Will try again momentarily..."};a.current in b?(n(!1,!1),Y(b[event.current])):a.current==="connected"&&(n(!0,!0),Y(!1))}function n(a,b){i.enabled!==a&&(i.enabled=a,s(a),i.role==="passenger"&&o(!a)),i.switchable!==b&&b!==undefined&&(i.switchable=b),i.switchable?i.switches.slider("enable"):i.switches.slider("disable");var c=a?"syncing":"off";i.switches.val(c).slider("refresh")}function o(a){var b=!!a;if(i.manual!==b){var c=(i.manual=b)?"on":"off",d="swipeleft swiperight keyup";g.document[c](d,p)}}function p(a){var b=".ui-focus,.ui-focus *";if(!f(a.target).is(b))if(a.type==="swipeleft")q();else if(a.type==="swiperight")r();else switch(a.which){case 37:r();break;case 39:case 32:q()}}function q(){var a=h.slide,b=h.step,c=a+1,d=b+1;J(a).then(function(b){var e=b.data("steps").not(".active");e.size()>0?F(d,a):c<h.slideCount&&F(0,c)})}function r(){var a=h.slide,b=h.step,c=a-1,d=b-1;d>=0?F(d,a):c>=0&&F(0,c)}function s(a){f.each(h.slides,function(b,c){c.then&&c.then(function(b){var c=b.data("alternators"),d="ui-bar-"+c.data("sync-theme");c.toggleClass(d,a)})})}function t(){g.body.addClass(i.role="passenger"),g.body.removeClass("driver"),v("sync","state",T),o(!!i.manual)}function u(){g.body.addClass(i.role="driver"),g.body.removeClass("passenger"),w("sync","state",T),o(!0)}function v(a,b,c){if(a&&i.api){var d=y(a);b&&c&&d.bind(b,c)}}function w(a,b,c){if(a in i.channels&&i.api){var d=y(a);b&&c&&d.unbind(b,c)}}function x(a,b,c){return f.ajax({url:i.server,type:"POST",contentType:"application/json",data:JSON.stringify({channel:a,event:b,data:c})})}function y(a){return a==="connection"?i.api.connection:a in i.channels?i.channels[a]:i.channels[a]=i.api.subscribe(a)}function z(a,b){return f.get(A(a,b))}function A(a,b){return b&&(h.rootFolder=b),h.rootFolder+"/"+a}function B(a){h.template=a}function C(){var a=D(location);F(a.step,a.slide,{transition:"fade"})}function D(b){var c=b?e.path.parseUrl(b):a.location,d=c.hash.split("#").pop(),g=d.split("&"),h={slide:0,step:0};return f.each(g,function(a,b){b=b.split("="),h[b[0]]=parseInt(b[1],10)}),h}function E(a){a?e.showPageLoadingMsg("a",a,!0):e.hidePageLoadingMsg()}function F(a,b,c){a=G(a)?a:0,b=G(b)?b:0,e.changePage("#slide="+b+"&step="+a,c)}function G(a){return f.type(a)==="number"&&a>=0}function H(a,b){var c=b.toPage;if(f.type(c)==="string"){var d=D(c);I(d.slide,d.step,b),a.preventDefault()}}function I(a,b,c){E("loading slide"),i.role==="driver"&&T({slide:a,step:b});var d={dataUrl:c.toPage,allowSamePageTransition:!0,reverse:a<h.slide};h.slide=a,h.step=b,J(a).then(function(g){var i={transition:"none"};h.slide!==a&&(i.transition=g.data("transition")||"slide",S(0,0));var j=c.options||{},k=f.extend(i,j,d);e.changePage(g,k),Q(b,g),U("update",{page:g,slide:h.slide,step:h.step})}).fail(function(a){Y("Unable to find slide #"+a)})}function J(a){var b=h.slides[a];return b===undefined?f.Deferred().reject(a):(b.then||(b=h.slides[a]=K(b)),b.promise())}function K(a){var b=f.Deferred();return z(a).then(function(a){L(a).then(b.resolve)}),b.promise()}function L(a){var b=f.Deferred(),d=P(a),e=d.find("[data-role=content]"),i=d.find(".alert"),j=d.find("link[href]").remove(),k=d.find("[data-step]"),l=d.find("[data-sync-theme]"),m=e.attr("id")||h.slide,n=e.data("page-step");n&&k.push(d.attr("data-step",n).get(0)),d.attr("id",m+"-page").data({steps:k,alternators:l,alert:i}).appendTo(g.body).page();var o=d.find(".sync");o.size()&&o.each(N).change(O),i.size()&&i.on("click",function(){i.removeClass("active")});var p=f.makeArray(j.map(M)),q=function(){b.resolve(d)};return p.length?c({load:p,complete:q}):q(),b.promise()}function M(a,b){var c=f(b).attr("href");return c in h.assets?undefined:(h.assets[c]=!0,A(c))}function N(a,b){i.switches.push(b),n(i.enabled)}function O(a){var b=f(a.target).val();n(b==="syncing"),g.body.focus()}function P(a){var b=/\{\{([a-z]+)\}\}/g,c=h.template,d=c.replace(b,function(b,c){if(c==="content")return a;if(c==="index")return h.slide+1;if(c==="count")return h.slideCount});return f(d)}function Q(a,b){var c,d=100;b.data("steps").each(function(){var b=f(this),d=b.data("step")<=a;d?(!b.hasClass("active")&&!c&&(c=b),b.addClass("active")):b.removeClass("active")}),c&&!R(c,d)&&S(c.offset().top-d)}function R(b,c){var d=b.get(0),e=d.offsetTop,f=d.offsetLeft,g=d.offsetWidth,h=d.offsetHeight;while(d.offsetParent)d=d.offsetParent,e+=d.offsetTop,f+=d.offsetLeft;return e>=a.pageYOffset&&f>=a.pageXOffset&&e+h<=a.pageYOffset+a.innerHeight-(c||0)&&f+g<=a.pageXOffset+a.innerWidth}function S(a,b){var c=Math.max(a,0),d=b!==undefined?b:500,e=function(){g.window.trigger("resize")};g.html.animate({scrollTop:c},{duration:d,step:e})}function T(a){i.enabled&&(i.role==="passenger"?F(a.step,a.slide):x("sync","state",a))}function U(a,b){g.window.trigger(X(a),b)}function V(a,b){g.window.on(X(a),b)}function W(a,b){g.window.off(X(a),b)}function X(a){return"tacion:"+a}function Y(b){E(!1);var c=function(){f.type(b)==="string"&&a.alert(b)};J(h.slide).then(function(a){var d=a.data("alert");d?f.type(b)==="string"?(d.children(".message").text(b),d.addClass("active"),S(0)):d.removeClass("active"):c()}).fail(c)}"use strict";var g={window:f(a)},h={assets:{},slide:0,step:0},i={enabled:!1,switches:f(),channels:{}};a.tacion={alert:Y,change:F,next:q,off:W,on:V,prev:r,spinner:E,start:j}})(window,document,yepnope,Pusher,jQuery.mobile,jQuery),function(a,b){"use strict";var c=a.getActive,d=$(b);a.getActive=function(){var a=c()||{};return a.lastScroll===undefined&&(a.lastScroll=d.scrollTop()),a}}(jQuery.mobile.urlHistory,window);